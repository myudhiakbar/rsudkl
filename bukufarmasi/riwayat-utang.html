<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Buku Utang Farmasi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/style.css">
</head>

<!-- <body data-page="riwayat"> -->

<body class="text-gray-800">
    <!-- NAVBAR AKAN DIMUAT DI SINI -->
    <!-- <div id="nav-placeholder"></div> -->
    <header class="bg-gradient-to-r from-blue-800 to-blue-500 text-white p-4 shadow-md">
        <div class="flex items-center gap-3">
            <div class="text-2xl">üè•</div>
            <div>
                <h1 class="text-lg font-semibold">Buku Utang Farmasi RSUD KL</h1>
                <p id="nowDateTime" class="text-sm opacity-90"></p>
            </div>
        </div>
    </header>

    <nav class="bg-white shadow-sm px-4">
        <div class="flex justify-center gap-6 text-blue-600 font-medium py-3">
            <a href="index.html" class="nav-link">Form Peminjaman</a>
            <a href="riwayat-utang.html" class="nav-link">Riwayat Peminjaman</a>
        </div>
    </nav>

    <main class="container mx-auto px-4 py-8">
        <div class="flex justify-center px-4">
            <div class="w-full max-w-6xl">

                <div class="form-container p-6 mb-8">
                    <div class="header-gradient text-white rounded-t-xl p-4 -mx-6 -mt-6 mb-6">
                        <h2 class="text-lg font-bold">
                            <i class="fas fa-history mr-2"></i>Riwayat Terakhir
                        </h2>
                    </div>

                    <!-- HISTORY LIST -->
                    <div id="historyList" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                        <div class="text-center py-8 text-gray-500 col-span-full">
                            <i class="fas fa-clipboard-list text-3xl mb-3"></i>
                            <p>Belum ada transaksi</p>
                            <p class="text-sm">Transaksi yang disimpan akan muncul di sini</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- FOOTER AKAN DIMUAT DI SINI -->
        <!-- <footer id="footer-placeholder"></footer> -->
        <footer class="mt-12 pt-6 border-t border-gray-300 text-center text-gray-600">
            <p class="mb-2">Aplikasi Buku Utang Farmasi &copy; <span id="year"></span></p>
            <p class="text-sm">Created by M Yudhi Akbar</p>
        </footer>
    </main>

    <!-- <script src="assets/loadhistory.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // ===== FORMAT TANGGAL =====
        function formatTanggalIndonesia(tanggalString) {
            const date = new Date(tanggalString);
            if (isNaN(date)) return tanggalString;

            return date.toLocaleDateString("id-ID", {
                day: "2-digit",
                month: "long",
                year: "numeric",
            });
        }

        function updateNowDateTime() {
            const el = document.getElementById("nowDateTime");
            if (!el) return;

            el.textContent =
                new Date().toLocaleString("id-ID", {
                    timeZone: "Asia/Jakarta",
                    day: "2-digit",
                    month: "long",
                    year: "numeric",
                    hour: "2-digit",
                    minute: "2-digit",
                    second: "2-digit",
                }) + " WIB";
        }

        const WEB_APP_URL =
            "https://script.google.com/macros/s/AKfycbwnsxv605i4E3R7OOF7EdZCcX97o_MyIyB_us5cgEmm_FhUVM6txENGUxMa1UkDd-Qq/exec";

        /* ====== LOAD HISTORY DARI GAS ====== */
        function loadHistory() {
            const historyList = document.getElementById("historyList");

            historyList.innerHTML = `
        <div class="text-center py-6 text-gray-500 animate-pulse">
            Sedang mengambil data dari server...
        </div>
    `;

            fetch(WEB_APP_URL, {
                method: "POST",
                body: JSON.stringify({ action: "read" }),
            })
                .then((res) => res.json())
                .then((res) => {
                    historyList.innerHTML = "";

                    if (res.status !== "success" || !res.data.length) {
                        historyList.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-clipboard-list text-3xl mb-3"></i>
                        <p>Belum ada transaksi</p>
                        <p class="text-sm">Data otomatis ditarik dari Google Sheet</p>
                    </div>`;
                        return;
                    }

                    res.data
                        .sort(
                            (a, b) =>
                                new Date(b.timestamp || b.tanggal) - new Date(a.timestamp || a.tanggal),
                        )
                        .forEach((trx) => {
                            const sudah = (trx.verifikasi || "").toLowerCase() === "sudah";

                            const card = document.createElement("div");
                            card.className = sudah
                                ? "p-4 rounded border bg-green-50 border-green-200"
                                : "p-4 rounded border bg-white border-gray-200";

                            const tanggalFormatted = formatTanggalIndonesia(trx.tanggal);

                            let jamFormatted = "";
                            if (trx.timestamp) {
                                const d = new Date(trx.timestamp);
                                if (!isNaN(d)) {
                                    jamFormatted = d.toLocaleTimeString("id-ID", {
                                        hour: "2-digit",
                                        minute: "2-digit",
                                    });
                                }
                            }

                            const badge = sudah
                                ? `<span onclick="editData('${trx.id}','Sudah')" class="cursor-pointer text-xs px-2 py-1 bg-green-100 text-green-700 rounded">Sudah Terinput</span>`
                                : `<span onclick="editData('${trx.id}','Belum')" class="cursor-pointer text-xs px-2 py-1 bg-red-100 text-red-700 rounded">Belum Terinput</span>`;

                            let alkesHTML = '<ul class="list-disc ml-5 text-lg md:text-sm mt-2">';
                            if (Array.isArray(trx.alkes) && trx.alkes.length) {
                                trx.alkes.forEach((item) => {
                                    alkesHTML += `<li>${item.name} <span class="font-semibold">= ${item.qty} pcs</span></li>`;
                                });
                            } else {
                                alkesHTML += '<li class="italic text-gray-500">Tidak ada data alkes</li>';
                            }
                            alkesHTML += "</ul>";

                            card.innerHTML = `
                    <div class="text-sm text-gray-500">
                        ${tanggalFormatted}${jamFormatted ? " , jam " + jamFormatted : ""}
                    </div>

                    Nama Pasien : ${trx.namaPasien || "-"}<br>
                    ${trx.petugas || "-"} - ${trx.unit || "-"}<br>

                    <div class="mt-2">
                        <span class="text-lg text-gray-700"><strong>Alkes Dipinjam:</strong></span>
                        ${alkesHTML}
                    </div>

                    <div class="mt-2 text-right">${badge}</div>
                `;

                            historyList.appendChild(card);
                        });
                })
                .catch(() => {
                    historyList.innerHTML = `<div class="text-center text-red-500">Gagal terhubung ke server</div>`;
                });
        }

        /* ================= TOGGLE VERIFIKASI ================= */
        function editData(id, currentStatus = "Belum") {
            const statusBaru = currentStatus.toLowerCase() === "sudah" ? "Belum" : "Sudah";
            const teksKonfirmasi =
                statusBaru === "Sudah"
                    ? "Tandai data ini sebagai Sudah Terinput?"
                    : "Batalkan status Sudah Terinput?";

            Swal.fire({
                title: "Ubah Status Verifikasi",
                text: teksKonfirmasi,
                icon: "question",
                showCancelButton: true,
                confirmButtonText: "Ya",
                cancelButtonText: "Batal",
                confirmButtonColor: statusBaru === "Sudah" ? "#16a34a" : "#dc2626",
                reverseButtons: true,
                showLoaderOnConfirm: true,
                allowOutsideClick: () => !Swal.isLoading(),

                preConfirm: async () => {
                    try {
                        const res = await fetch(WEB_APP_URL, {
                            method: "POST",
                            body: JSON.stringify({
                                action: "updateVerifikasi", // üî• KHUSUS UPDATE KOLOM H
                                id: id,
                                verifikasi: statusBaru,
                            }),
                        });

                        if (!res.ok) throw new Error("Server tidak merespon");

                        const data = await res.json();
                        if (data.status !== "success") {
                            throw new Error(data.message || "Gagal update");
                        }

                        return data;
                    } catch (err) {
                        Swal.showValidationMessage(`Error: ${err.message}`);
                    }
                },
            }).then((result) => {
                if (!result.isConfirmed) return;

                Swal.fire({
                    icon: "success",
                    title: "Berhasil",
                    text: `Status diubah menjadi ${statusBaru}`,
                    timer: 1200,
                    showConfirmButton: false,
                });

                loadHistory(); // üîÑ refresh tampilan
            });
        }

        // ==== ENTRY POINT ====
        document.addEventListener("DOMContentLoaded", () => {
            loadHistory();
            updateNowDateTime();
            setInterval(updateNowDateTime, 1000);
        });
    </script>
</body>

</html>